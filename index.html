<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åª’é«”æ•ˆç›Šè¨ˆç®—æ©Ÿ (å«é »ç‡)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ä½¿ç”¨æ¨‚é«˜ç¶“å…¸é…è‰² */
        :root {
            --lego-red: #DD1E26;
            --lego-yellow: #FFC20A;
            --lego-blue: #004889;
            --lego-green: #4C9900;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0; /* æ·ºç°è‰²èƒŒæ™¯ï¼Œè®“æ¨‚é«˜é¡è‰²æ›´çªå‡º */
            color: #1f2937;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem;
        }
        .input-field {
            width: 90px;
            text-align: center;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            padding: 0.25rem;
            transition: all 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--lego-blue);
            box-shadow: 0 0 0 3px rgba(0, 72, 137, 0.5);
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .add-btn {
            background-color: var(--lego-yellow);
            color: #1f2937;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .download-btn {
            background-color: var(--lego-red);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .remove-btn {
            color: var(--lego-red);
        }
        .remove-btn:hover {
            color: #b2181f;
        }
    </style>
</head>
<body>
    <div class="container py-8">
        <div class="bg-white rounded-xl shadow-2xl p-8 mb-8">
            <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-2">åª’é«”æ•ˆç›Šè¨ˆç®—æ©Ÿ</h1>
            <p class="text-center text-gray-600 mb-6">
                æ ¹æ“šç›®æ¨™å—çœ¾ã€é è¨ˆè§¸åŠç‡ã€é »ç‡èˆ‡CPMï¼Œå¿«é€Ÿè©•ä¼°åª’é«”é ç®—ã€‚
            </p>
        </div>

        <div id="calculator-container" class="space-y-8">
            <!-- Hong Kong Table -->
            <div class="bg-white rounded-xl shadow-lg p-6 w-full">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">é¦™æ¸¯ (Hong Kong)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç›®æ¨™å—çœ¾</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åŸºæ•¸äººæ•¸</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é è¨ˆè§¸åŠç‡ (%)</th>
                                <th scope="col" colspan="3" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">Display</th>
                                <th scope="col" colspan="3" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">Social</th>
                                <th scope="col" colspan="3" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">Video</th>
                                <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                            <tr>
                                <th scope="col"></th>
                                <th scope="col"></th>
                                <th scope="col"></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPM</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é »ç‡</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é ç®—</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">CPM</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é »ç‡</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é ç®—</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">CPM</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é »ç‡</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é ç®—</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                            </tr>
                        </thead>
                        <tbody id="hk-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-center">
                    <button id="add-hk-row-btn" class="add-btn">
                        æ–°å¢å—çœ¾ â•
                    </button>
                </div>
            </div>

            <!-- Taiwan Table -->
            <div class="bg-white rounded-xl shadow-lg p-6 w-full">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">å°ç£ (Taiwan)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç›®æ¨™å—çœ¾</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åŸºæ•¸äººæ•¸</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é è¨ˆè§¸åŠç‡ (%)</th>
                                <th scope="col" colspan="3" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">Display</th>
                                <th scope="col" colspan="3" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">Social</th>
                                <th scope="col" colspan="3" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">Video</th>
                                <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                            <tr>
                                <th scope="col"></th>
                                <th scope="col"></th>
                                <th scope="col"></th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPM</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é »ç‡</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é ç®—</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">CPM</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é »ç‡</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é ç®—</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">CPM</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é »ç‡</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é ç®—</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                            </tr>
                        </thead>
                        <tbody id="tw-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-center">
                    <button id="add-tw-row-btn" class="add-btn">
                        æ–°å¢å—çœ¾ â•
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 text-center mt-8">
            <button id="download-csv-btn" class="download-btn">
                ä¸‹è¼‰ç‚º CSV ğŸ“Š
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Hardcoded base audience data
            const audienceData = [
                { name: 'Adults', country: 'Hong Kong', base: 6351357 },
                { name: 'Parents of Kids (6 to 12)', country: 'Hong Kong', base: 1080497 },
                { name: 'Pre-school Parents', country: 'Hong Kong', base: 338874 },
                { name: 'Boys 6-12', country: 'Hong Kong', base: 197882 },
                { name: 'Girls 6-12', country: 'Hong Kong', base: 192629 },
                { name: 'Adults', country: 'Taiwan', base: 8529221 },
                { name: 'Parents of Kids (6 to 12)', country: 'Taiwan', base: 3404197 },
                { name: 'Pre-school Parents', country: 'Taiwan', base: 1742370 },
                { name: 'Boys 6-12', country: 'Taiwan', base: 726078 },
                { name: 'Girls 6-12', country: 'Taiwan', base: 676613 },
            ];

            const formatNumber = (num) => {
                if (num === null || isNaN(num) || num === Infinity) return '0';
                return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(num);
            };

            const calculateBudget = (base, reach, cpm, frequency) => {
                const reachValue = parseFloat(reach);
                const cpmValue = parseFloat(cpm);
                const frequencyValue = parseFloat(frequency);

                if (isNaN(reachValue) || isNaN(cpmValue) || isNaN(frequencyValue) || reachValue < 0 || cpmValue < 0 || frequencyValue < 0) return 0;

                const targetReach = (base * reachValue) / 100;
                const totalImpressions = targetReach * frequencyValue;
                return (totalImpressions / 1000) * cpmValue;
            };

            const createNewRow = (country, audienceName = 'æ–°å—çœ¾', baseAudience = '') => {
                const tbody = document.getElementById(country === 'Hong Kong' ? 'hk-tbody' : 'tw-tbody');
                if (!tbody) return;

                const currencySymbol = country === 'Taiwan' ? 'NT$' : 'HK$';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition-colors duration-150 ease-in-out';
                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${audienceName === 'æ–°å—çœ¾' ? `<input type="text" value="${audienceName}" class="input-field w-auto" placeholder="å—çœ¾åç¨±">` : audienceName}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${baseAudience !== '' ? formatNumber(baseAudience) : `<input type="number" placeholder="äººæ•¸" class="input-field base-input w-24">`}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        <input type="number" placeholder="e.g. 50" class="input-field reach-input">
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        <input type="number" placeholder="e.g. 5" class="input-field cpm-input" data-media="display">
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        <input type="number" placeholder="e.g. 3" class="input-field frequency-input" data-media="display">
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-bold budget-output" data-media="display">${currencySymbol}0</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 border-l border-gray-200">
                        <input type="number" placeholder="e.g. 10" class="input-field cpm-input" data-media="social">
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        <input type="number" placeholder="e.g. 3" class="input-field frequency-input" data-media="social">
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-bold budget-output" data-media="social">${currencySymbol}0</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 border-l border-gray-200">
                        <input type="number" placeholder="e.g. 25" class="input-field cpm-input" data-media="video">
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        <input type="number" placeholder="e.g. 3" class="input-field frequency-input" data-media="video">
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-bold budget-output" data-media="video">${currencySymbol}0</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                        <button class="remove-row-btn remove-btn">ç§»é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);

                // Add event listeners for the new row
                const newRow = tbody.lastElementChild;
                const baseInput = newRow.querySelector('.base-input');
                const reachInput = newRow.querySelector('.reach-input');
                const mediaInputs = newRow.querySelectorAll('[data-media]');

                const updateRowBudgets = () => {
                    let baseValue = baseAudience;
                    if (baseInput) {
                        baseValue = parseFloat(baseInput.value);
                    }
                    if (isNaN(baseValue) || baseValue <= 0) {
                        newRow.querySelectorAll('.budget-output').forEach(el => el.textContent = `${currencySymbol}0`);
                        return;
                    }
                    const reachValue = parseFloat(reachInput.value);
                    
                    ['display', 'social', 'video'].forEach(mediaType => {
                        const cpmInput = newRow.querySelector(`.cpm-input[data-media="${mediaType}"]`);
                        const frequencyInput = newRow.querySelector(`.frequency-input[data-media="${mediaType}"]`);
                        const cpmValue = parseFloat(cpmInput.value);
                        const frequencyValue = parseFloat(frequencyInput.value);
                        
                        const budget = calculateBudget(baseValue, reachValue, cpmValue, frequencyValue);
                        const outputElement = newRow.querySelector(`.budget-output[data-media="${mediaType}"]`);
                        if (outputElement) {
                            outputElement.textContent = `${currencySymbol}${formatNumber(budget)}`;
                        }
                    });
                };
                
                if (baseInput) {
                    baseInput.addEventListener('input', updateRowBudgets);
                }
                reachInput.addEventListener('input', updateRowBudgets);
                mediaInputs.forEach(input => input.addEventListener('input', updateRowBudgets));
                
                const removeBtn = newRow.querySelector('.remove-row-btn');
                removeBtn.addEventListener('click', () => {
                    newRow.remove();
                });
            };

            const renderInitialRows = (country) => {
                const filteredAudience = audienceData.filter(item => item.country === country);
                filteredAudience.forEach((audience) => {
                    createNewRow(country, audience.name, audience.base);
                });
            };

            // æ–°å¢çš„ CSV åŒ¯å‡ºåŠŸèƒ½
            const exportToCsv = () => {
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                const filename = `media-budget-calculator-${dateStr}.csv`;
                
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF for UTF-8 BOM
                
                // CSV header
                const header = "åœ°å€,ç›®æ¨™å—çœ¾,åŸºæ•¸äººæ•¸,é è¨ˆè§¸åŠç‡(%),Display CPM,Display é »ç‡,Display é ç®—,Social CPM,Social é »ç‡,Social é ç®—,Video CPM,Video é »ç‡,Video é ç®—\n";
                csvContent += header;

                const tables = [
                    { country: 'é¦™æ¸¯', id: 'hk-tbody' },
                    { country: 'å°ç£', id: 'tw-tbody' }
                ];

                tables.forEach(tableInfo => {
                    const tbody = document.getElementById(tableInfo.id);
                    if (!tbody) return;

                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const audienceName = row.querySelector('td:nth-child(1) input') ? row.querySelector('td:nth-child(1) input').value : row.querySelector('td:nth-child(1)').textContent.trim();
                        const baseAudience = row.querySelector('.base-input') ? row.querySelector('.base-input').value : row.querySelector('td:nth-child(2)').textContent.trim().replace(/,/g, '');
                        const reach = row.querySelector('.reach-input').value;
                        const displayCpm = row.querySelector('input[data-media="display"].cpm-input').value;
                        const displayFrequency = row.querySelector('input[data-media="display"].frequency-input').value;
                        const displayBudget = row.querySelector('td[data-media="display"].budget-output').textContent.trim();
                        const socialCpm = row.querySelector('input[data-media="social"].cpm-input').value;
                        const socialFrequency = row.querySelector('input[data-media="social"].frequency-input').value;
                        const socialBudget = row.querySelector('td[data-media="social"].budget-output').textContent.trim();
                        const videoCpm = row.querySelector('input[data-media="video"].cpm-input').value;
                        const videoFrequency = row.querySelector('input[data-media="video"].frequency-input').value;
                        const videoBudget = row.querySelector('td[data-media="video"].budget-output').textContent.trim();
                        
                        const rowData = [
                            tableInfo.country,
                            audienceName,
                            baseAudience,
                            reach,
                            displayCpm,
                            displayFrequency,
                            displayBudget,
                            socialCpm,
                            socialFrequency,
                            socialBudget,
                            videoCpm,
                            videoFrequency,
                            videoBudget
                        ].map(data => `"${(data + '').replace(/"/g, '""')}"`).join(',');
                        
                        csvContent += rowData + "\n";
                    });
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Initial render and setup
            renderInitialRows('Hong Kong');
            renderInitialRows('Taiwan');
            
            // Event listeners for adding rows
            document.getElementById('add-hk-row-btn').addEventListener('click', () => createNewRow('Hong Kong'));
            document.getElementById('add-tw-row-btn').addEventListener('click', () => createNewRow('Taiwan'));
            document.getElementById('download-csv-btn').addEventListener('click', exportToCsv);
        });
    </script>
</body>
</html>
