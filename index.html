<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>媒體效益計算機 (含頻率)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem;
        }
        .input-field {
            width: 90px;
            text-align: center;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            padding: 0.25rem;
            transition: all 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
        }
    </style>
</head>
<body>
    <div class="container py-8">
        <div class="bg-white rounded-xl shadow-2xl p-8 mb-8">
            <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-2">媒體效益計算機</h1>
            <p class="text-center text-gray-600 mb-6">
                根據目標受眾、預計觸及率、頻率與CPM，快速評估媒體預算。
            </p>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 w-full">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">香港 (Hong Kong)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">目標受眾</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">基數人數</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">預計觸及率 (%)</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">頻率</th>
                            <th scope="col" colspan="2" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Display</th>
                            <th scope="col" colspan="2" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">Social</th>
                            <th scope="col" colspan="2" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">Video</th>
                        </tr>
                        <tr>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPM</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">預算</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">CPM</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">預算</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">CPM</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">預算</th>
                        </tr>
                    </thead>
                    <tbody id="hk-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 w-full">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">台灣 (Taiwan)</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">目標受眾</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">基數人數</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">預計觸及率 (%)</th>
                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">頻率</th>
                            <th scope="col" colspan="2" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Display</th>
                            <th scope="col" colspan="2" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">Social</th>
                            <th scope="col" colspan="2" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">Video</th>
                        </tr>
                        <tr>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPM</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">預算</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">CPM</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">預算</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-l border-gray-200">CPM</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">預算</th>
                        </tr>
                    </thead>
                    <tbody id="tw-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
            <button id="download-csv-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 ease-in-out">
                下載為 CSV 📊
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Hardcoded base audience data
            const audienceData = [
                { name: 'Adults', country: 'Hong Kong', base: 6351357 },
                { name: 'Parents of Kids (6 to 12)', country: 'Hong Kong', base: 1080497 },
                { name: 'Pre-school Parents', country: 'Hong Kong', base: 338874 },
                { name: 'Boys 6-12', country: 'Hong Kong', base: 197882 },
                { name: 'Girls 6-12', country: 'Hong Kong', base: 192629 },
                { name: 'Adults', country: 'Taiwan', base: 8529221 },
                { name: 'Parents of Kids (6 to 12)', country: 'Taiwan', base: 3404197 },
                { name: 'Pre-school Parents', country: 'Taiwan', base: 1742370 },
                { name: 'Boys 6-12', country: 'Taiwan', base: 726078 },
                { name: 'Girls 6-12', country: 'Taiwan', base: 676613 },
            ];

            const formatNumber = (num) => {
                if (num === null || isNaN(num)) return '0';
                return new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(num);
            };

            const calculateBudget = (base, reach, cpm, frequency) => {
                const reachValue = parseFloat(reach);
                const cpmValue = parseFloat(cpm);
                const frequencyValue = parseFloat(frequency);

                if (isNaN(reachValue) || isNaN(cpmValue) || isNaN(frequencyValue) || reachValue < 0 || cpmValue < 0 || frequencyValue < 0) return 0;

                const targetReach = (base * reachValue) / 100;
                const totalImpressions = targetReach * frequencyValue;
                return (totalImpressions / 1000) * cpmValue;
            };

            const renderTableRows = (country) => {
                const tbody = document.getElementById(country === 'Hong Kong' ? 'hk-tbody' : 'tw-tbody');
                if (!tbody) return;
                tbody.innerHTML = '';

                const filteredAudience = audienceData.filter(item => item.country === country);
                const currencySymbol = country === 'Taiwan' ? 'NT$' : 'HK$';

                filteredAudience.forEach((audience) => {
                    const row = document.createElement('tr');
                    const base = audience.base;

                    row.innerHTML = `
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${audience.name}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${formatNumber(base)}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                            <input type="number" placeholder="e.g. 50" class="input-field reach-input" data-base="${base}">
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                            <input type="number" placeholder="e.g. 3" class="input-field frequency-input" data-base="${base}">
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                            <input type="number" placeholder="e.g. 5" class="input-field cpm-input" data-media="display" data-base="${base}">
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-bold budget-output" data-media="display">${currencySymbol}0</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 border-l border-gray-200">
                            <input type="number" placeholder="e.g. 10" class="input-field cpm-input" data-media="social" data-base="${base}">
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-bold budget-output" data-media="social">${currencySymbol}0</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 border-l border-gray-200">
                            <input type="number" placeholder="e.g. 25" class="input-field cpm-input" data-media="video" data-base="${base}">
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-bold budget-output" data-media="video">${currencySymbol}0</td>
                    `;
                    tbody.appendChild(row);
                });
            };

            const updateBudgets = (row) => {
                const reachInput = row.querySelector('.reach-input');
                const frequencyInput = row.querySelector('.frequency-input');
                if (!reachInput || !frequencyInput) return;

                const reachValue = reachInput.value;
                const frequencyValue = frequencyInput.value;
                const cpmInputs = row.querySelectorAll('.cpm-input');
                const base = parseFloat(reachInput.dataset.base);

                cpmInputs.forEach(cpmInput => {
                    const mediaType = cpmInput.dataset.media;
                    const cpmValue = cpmInput.value;
                    const budget = calculateBudget(base, reachValue, cpmValue, frequencyValue);
                    const outputElement = row.querySelector(`.budget-output[data-media="${mediaType}"]`);
                    if (outputElement) {
                        const currencySymbol = outputElement.textContent.startsWith('NT') ? 'NT$' : 'HK$';
                        outputElement.textContent = `${currencySymbol}${formatNumber(budget)}`;
                    }
                });
            };

            // 新增的 CSV 匯出功能
            const exportToCsv = () => {
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                const filename = `media-budget-calculator-${dateStr}.csv`;
                
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF for UTF-8 BOM
                
                // CSV header
                const header = "地區,目標受眾,基數人數,預計觸及率(%),頻率,Display CPM,Display 預算,Social CPM,Social 預算,Video CPM,Video 預算\n";
                csvContent += header;

                const tables = [
                    { country: '香港', id: 'hk-tbody' },
                    { country: '台灣', id: 'tw-tbody' }
                ];

                tables.forEach(tableInfo => {
                    const tbody = document.getElementById(tableInfo.id);
                    if (!tbody) return;

                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const audienceName = row.querySelector('td:nth-child(1)').textContent.trim();
                        const baseAudience = row.querySelector('td:nth-child(2)').textContent.trim();
                        const reach = row.querySelector('.reach-input').value;
                        const frequency = row.querySelector('.frequency-input').value;
                        const displayCpm = row.querySelector('input[data-media="display"]').value;
                        const displayBudget = row.querySelector('td[data-media="display"]').textContent.trim();
                        const socialCpm = row.querySelector('input[data-media="social"]').value;
                        const socialBudget = row.querySelector('td[data-media="social"]').textContent.trim();
                        const videoCpm = row.querySelector('input[data-media="video"]').value;
                        const videoBudget = row.querySelector('td[data-media="video"]').textContent.trim();
                        
                        const rowData = [
                            tableInfo.country,
                            audienceName,
                            baseAudience,
                            reach,
                            frequency,
                            displayCpm,
                            displayBudget,
                            socialCpm,
                            socialBudget,
                            videoCpm,
                            videoBudget
                        ].map(data => `"${data.replace(/"/g, '""')}"`).join(','); // 處理包含逗號或引號的字串
                        
                        csvContent += rowData + "\n";
                    });
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const setupEventListeners = () => {
                document.querySelectorAll('.min-w-full tbody').forEach(tbody => {
                    tbody.addEventListener('input', (event) => {
                        const target = event.target;
                        if (target.classList.contains('reach-input') || target.classList.contains('cpm-input') || target.classList.contains('frequency-input')) {
                            const row = target.closest('tr');
                            if (row) {
                                updateBudgets(row);
                            }
                        }
                    });
                });
                
                // 監聽下載按鈕的點擊事件
                document.getElementById('download-csv-btn').addEventListener('click', exportToCsv);
            };

            // Initial render and setup
            renderTableRows('Hong Kong');
            renderTableRows('Taiwan');
            setupEventListeners();
        });
    </script>
</body>
</html>
